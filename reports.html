{% extends 'base.html' %}

{% block title %}Custom Reports â€” Future Energy{% endblock %}

{% block content %}
<div class="hero">
    <h1 class="h4 mb-1">Custom Report Builder</h1>
    <div class="text-muted small">Generate filtered reports based on your criteria</div>
</div>

<div class="row">
    <div class="col-lg-4">
        <div class="card shadow-sm p-4">
            <h5 class="card-title mb-3">ðŸ“‹ Report Filters</h5>
            <form id="filterForm">
                <div class="mb-3">
                    <label class="form-label">Start Year</label>
                    <input type="number" class="form-control" id="yearStart" placeholder="e.g., 2020">
                </div>
                <div class="mb-3">
                    <label class="form-label">End Year</label>
                    <input type="number" class="form-control" id="yearEnd" placeholder="e.g., 2024">
                </div>
                <div class="mb-3">
                    <label class="form-label">Month (optional)</label>
                    <select class="form-select" id="month">
                        <option value="">All Months</option>
                        <option value="1">January</option>
                        <option value="2">February</option>
                        <option value="3">March</option>
                        <option value="4">April</option>
                        <option value="5">May</option>
                        <option value="6">June</option>
                        <option value="7">July</option>
                        <option value="8">August</option>
                        <option value="9">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                </div>
                <button type="button" class="btn btn-primary w-100" onclick="generateReport()">
                    <i class="bi bi-search"></i> Generate Report
                </button>
                <button type="button" class="btn btn-outline-secondary w-100 mt-2" onclick="exportReportCSV()">
                    <i class="bi bi-download"></i> Export CSV
                </button>
            </form>
        </div>
    </div>

    <div class="col-lg-8">
        <div id="reportResults" class="d-none">
            <div class="card shadow-sm p-4">
                <h5 class="card-title mb-3">ðŸ“Š Report Results</h5>
                
                <!-- Key Metrics -->
                <div class="row g-2 mb-4">
                    <div class="col-sm-6">
                        <div class="p-3 bg-light rounded">
                            <div class="small text-muted">Total Records</div>
                            <div class="h5 mb-0" id="totalRecords">-</div>
                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="p-3 bg-light rounded">
                            <div class="small text-muted">Average Consumption</div>
                            <div class="h5 mb-0" id="avgConsumption">-</div>
                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="p-3 bg-light rounded">
                            <div class="small text-muted">Max Consumption</div>
                            <div class="h5 mb-0" id="maxConsumption">-</div>
                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="p-3 bg-light rounded">
                            <div class="small text-muted">Min Consumption</div>
                            <div class="h5 mb-0" id="minConsumption">-</div>
                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="p-3 bg-light rounded">
                            <div class="small text-muted">Std Deviation</div>
                            <div class="h5 mb-0" id="stdDev">-</div>
                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="p-3 bg-light rounded">
                            <div class="small text-muted">Total Revenue</div>
                            <div class="h5 mb-0" id="totalRevenue">-</div>
                        </div>
                    </div>
                </div>

                <!-- Additional Metrics -->
                <div class="row g-2 mb-4">
                    <div class="col-sm-6">
                        <div class="p-3 bg-info bg-opacity-10 rounded">
                            <div class="small text-muted">Avg Population</div>
                            <div class="h5 mb-0" id="avgPopulation">-</div>
                        </div>
                    </div>
                    <div class="col-sm-6">
                        <div class="p-3 bg-info bg-opacity-10 rounded">
                            <div class="small text-muted">Avg Industrial Growth</div>
                            <div class="h5 mb-0" id="avgGrowth">-</div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Statistics Table -->
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Metric</th>
                                <th>Count</th>
                                <th>Mean</th>
                                <th>Std</th>
                                <th>Min</th>
                                <th>25%</th>
                                <th>50%</th>
                                <th>75%</th>
                                <th>Max</th>
                            </tr>
                        </thead>
                        <tbody id="summaryTable">
                            <tr><td colspan="9" class="text-center text-muted">Generate a report to see detailed statistics</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="noResults" class="card shadow-sm p-4">
            <div class="text-center text-muted">
                <i class="bi bi-file-earmark-pdf" style="font-size: 3rem;"></i>
                <p class="mt-3">Select filters and click "Generate Report" to view results</p>
            </div>
        </div>

        <div id="loading" class="d-none text-center mt-5">
            <div class="spinner-border text-primary"></div>
            <p class="mt-2">Generating report...</p>
        </div>
    </div>
</div>

<!-- Report Examples -->
<div class="row mt-5">
    <div class="col-md-6">
        <div class="card p-3">
            <h6 class="mb-2">ðŸ’¡ Sample Queries</h6>
            <ul class="small mb-0">
                <li>Peak months: Filter by specific month to find highest consumption periods</li>
                <li>Yearly trend: Compare start and end year data</li>
                <li>Recent data: Narrow date range for focused analysis</li>
            </ul>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card p-3">
            <h6 class="mb-2">ðŸ“ˆ What You Get</h6>
            <ul class="small mb-0">
                <li>Statistical summary (mean, median, std dev)</li>
                <li>Revenue projections based on filtered data</li>
                <li>CSV export for further analysis</li>
                <li>Population and growth metrics</li>
            </ul>
        </div>
    </div>
</div>

<script>
async function generateReport() {
    document.getElementById('noResults').classList.add('d-none');
    document.getElementById('reportResults').classList.add('d-none');
    document.getElementById('loading').classList.remove('d-none');
    
    const filters = {
        year_start: document.getElementById('yearStart').value || null,
        year_end: document.getElementById('yearEnd').value || null,
        month: document.getElementById('month').value || null
    };
    
    try {
        const response = await fetch('/api/generate-report', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(filters)
        });
        
        const report = await response.json();
        
        if (report.error) {
            alert('Error: ' + report.error);
            document.getElementById('loading').classList.add('d-none');
            document.getElementById('noResults').classList.remove('d-none');
            return;
        }
        
        // Populate results
        document.getElementById('totalRecords').textContent = report.total_records;
        document.getElementById('avgConsumption').textContent = report.avg_consumption + ' kWh';
        document.getElementById('maxConsumption').textContent = report.max_consumption + ' kWh';
        document.getElementById('minConsumption').textContent = report.min_consumption + ' kWh';
        document.getElementById('stdDev').textContent = report.std_dev + ' kWh';
        document.getElementById('totalRevenue').textContent = 'â‚¹' + report.total_revenue;
        document.getElementById('avgPopulation').textContent = report.avg_population.toLocaleString();
        document.getElementById('avgGrowth').textContent = report.avg_growth + '%';
        
        // Populate summary table
        const summary = report.data_summary['Energy_Consumption'];
        const tableRow = `
            <tr>
                <td><strong>Energy Consumption</strong></td>
                <td>${Math.round(summary['count'])}</td>
                <td>${summary['mean'].toFixed(2)}</td>
                <td>${summary['std'].toFixed(2)}</td>
                <td>${summary['min'].toFixed(2)}</td>
                <td>${summary['25%'].toFixed(2)}</td>
                <td>${summary['50%'].toFixed(2)}</td>
                <td>${summary['75%'].toFixed(2)}</td>
                <td>${summary['max'].toFixed(2)}</td>
            </tr>
        `;
        document.getElementById('summaryTable').innerHTML = tableRow;
        
        document.getElementById('loading').classList.add('d-none');
        document.getElementById('reportResults').classList.remove('d-none');
        
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to generate report');
        document.getElementById('loading').classList.add('d-none');
        document.getElementById('noResults').classList.remove('d-none');
    }
}

async function exportReportCSV() {
    const filters = {
        year_start: document.getElementById('yearStart').value || null,
        year_end: document.getElementById('yearEnd').value || null,
        month: document.getElementById('month').value || null
    };
    
    try {
        const response = await fetch('/api/export-report', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(filters)
        });
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `energy_report_${new Date().getTime()}.csv`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to export report');
    }
}
</script>
{% endblock %}
